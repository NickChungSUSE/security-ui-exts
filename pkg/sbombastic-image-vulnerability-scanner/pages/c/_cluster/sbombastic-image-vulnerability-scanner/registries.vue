<template>
  <div class="page">
    <h2>{{ content }} ({{ rows.length }})</h2>
    <div style="margin-bottom: 20px;">Display CR data in resource table </div>
    <ResourceTable
      :schema="schema"
      :rows="rows"
      :namespaced="false"
      :headers="headers"
      :use-query-params-for-simple-filtering="true"
    />
    <hr style="margin: 20px 0;"/>
    <div style="margin-bottom: 20px;">CVE's amount bar by severity level </div>
    <AmountBarBySeverity style="margin: 10px;" :cveAmount="topRiskyImages[0].cve_cnt" />
    <AmountBarBySeverity style="margin: 10px;" :cveAmount="topRiskyImages[1].cve_cnt" />
    <hr style="margin: 20px 0;"/>
    <div style="margin-bottom: 20px;">Most affected images at risk</div>
    <TopRiskyImagesChart :topRiskyImages="topRiskyImages"/>
  </div>


</template>

<script>

  import { ref } from "vue";
  import { RESOURCE } from "@sbombastic-image-vulnerability-scanner/types";
  import ResourceTable from '@shell/components/ResourceTable';
  import AmountBarBySeverity from "@sbombastic-image-vulnerability-scanner/components/common/AmountBarBySeverity";
  import TopRiskyImagesChart from "@sbombastic-image-vulnerability-scanner/components/TopRiskyImagesChart";
  export default {
    name: 'registries',
    components: {
      ResourceTable,
      AmountBarBySeverity,
      TopRiskyImagesChart,
    },
    data() {
      return {
        topRiskyImages: [
          {
            image_name: "struts-attacher:1.0",
            cve_cnt: {
              critical: 128,
              high: 12,
              medium: 81,
              low: 256,
              none: 126,
            }
          },
          {
            image_name: "imagemagick4.8.5613",
            cve_cnt: {
              critical: 7,
              high: 0,
              medium: 1028,
              low: 24,
              none: 18,
            }
          },
          {
            image_name: "centos7.7.1908",
            cve_cnt: {
              critical: 72,
              high: 0,
              medium: 164,
              low: 0,
              none: 7,
            }
          },
          {
            image_name: "nginx1.19.10",
            cve_cnt: {
              critical: 150,
              high: 5,
              medium: 850,
              low: 600,
              none: 73,
            }
          },
          {
            image_name: "docker-compose:1.29.2",
            cve_cnt: {
              critical: 35,
              high: 2,
              medium: 450,
              low: 120,
              none: 9,
            }
          },
        ],
        content: ref("Registries"),
        headers: [
          {
            name:          'name',
            label:         'Name',
            value:         'id',
            sort:          ['nameSort'],
            canBeVariable: true,
          },
          {
            name:          'registries',
            label:         'Registries',
            value:         'spec.repositories',
            sort:          ['nameSort'],
            canBeVariable: true,
          },
          {
            name:          'uri',
            label:         'URI',
            value:         'spec.uri',
            sort:          ['nameSort'],
            canBeVariable: true,
          },
        ],
      }
    },

    async fetch() {
      await this.$store.dispatch('cluster/findAll', { type: RESOURCE.REGISTRY });
    },

    computed: {
      rows() {
        return this.$store.getters['cluster/all'](RESOURCE.REGISTRY);
      },
      schema() {
        return this.$store.getters['cluster/schemaFor'](RESOURCE.REGISTRY);
      }
    }
  }

</script>


<style scoped>
  .page {
    display: flex;
    flex-direction: column;
    padding: 20px;
    min-height: 100%;
  }

</style>